#include "stdio.h"
#include <stdlib.h>
#include <string.h>
#include "ctype.h"
#include <math.h>

typedef struct shop
{
    int barcode;
    char nazvanie[101];
    double cena;
    double kolvo;
} shop;

typedef struct tovar
{
    double kolvo;
    char nazvanie[100];

} tovar;

char sk[][100] = { "jus", "cucumber", "apple", "milk", "orange" };
int size_cklad = sizeof(sk) / sizeof(sk[0]);

shop* e;
tovar* zap;



int get_n() {
    int n;
    printf("Введите количество товаров\n");
    scanf("%d", &n);
    return n;
}

void set_shop(shop e[], int size) {

    srand(100);
    srand(time(NULL));
    int i;
    double pri, cou;
    for (i = 0; i < size; i++) {
        pri = rand() % 100;
        cou = rand() % 100;
        strcpy(e[i].nazvanie, sk[i]);
        e[i].cena = pri;
        e[i].kolvo = cou;
    }
}

void parse_str(char str[], int position, tovar a[]) {
    double kolvo;
    char nazvanie[100];
    char sep[10] = " ,.!;";
    char* istr;
    istr = strtok(str, sep);
    while (istr != NULL)
    {
        if (isdigit(*istr)) {
            kolvo = atol(istr);
        }
        else {
            strcpy(nazvanie, istr);
        }
        istr = strtok(NULL, sep);
    }
    strcpy(a[position - 1].nazvanie, nazvanie);
    a[position - 1].kolvo = kolvo;
}

void print_struct(tovar e[], int size) {
    for (int i = 0; i < size; i++) {
        printf("%s %lf\n", e[i].nazvanie, e[i].kolvo);
    }
}

int chek(char* str) {

    for (int i = 0; i < size_cklad; i++) {
        if (!strcmp(sk[i], str)) {
            return 1;
        }
    }
    return 0;
}

int get_id_tovar(char* str) {
    for (int i = 0; i < size_cklad; i++) {
        if (!strcmp(str, e[i].nazvanie)) {
            return e[i].barcode;
        }
    }
    return -1;
}

int check_tmp(tovar a[], int n, char* prod) {
    for (int i = 0; i < n; i++) {
        if (!strcmp(a[i].nazvanie, prod)) {
            return i;
        }
    }
    return -1;

}

void itog(tovar all[], int size) {
    double final = 0.0;
    zap = (tovar*)malloc(sizeof(tovar) * size_cklad);
    int n = 0;
    for (int i = 0; i < size; i++) {
        if (chek(all[i].nazvanie)) {
            int id = check_tmp(zap, n, all[i].nazvanie);
            if (id != -1) {
                zap[id].kolvo += all[i].kolvo;
            }
            else {
                strcpy(zap[n].nazvanie, all[i].nazvanie);
                zap[n].kolvo = all[i].kolvo;
                n++;
            }
        }
    }
    printf("Nazvanie     cena     itog\n");
    for (int i = 0; i < size; i++) {
        if (chek(zap[i].nazvanie)) {
            int id = get_id_tovar(zap[i].nazvanie);
            if (e[id - 1].kolvo >= zap[i].kolvo) {
                e[id - 1].kolvo -= zap[i].kolvo;
                printf("%s     %.2lf*%.2lf     %.2lf\n", e[id - 1].nazvanie, zap[i].kolvo, e[id - 1].cena, e[id - 1].cena * zap[i].kolvo);
                final += e[id - 1].cena * zap[i].kolvo;
            }
            else if (e[id - 1].kolvo > 0) {
                printf("%s     %.2lf*%.2lf     %.2lf\n", e[id - 1].nazvanie, e[id - 1].kolvo, e[id - 1].cena, e[id - 1].cena * e[id - 1].kolvo);
                final += e[id - 1].cena * e[id - 1].kolvo;
                e[id - 1].kolvo = 0.0;
            }
        }
    }

    printf("Itogova summa:         %.2lf\n", final);
}


void print_cklad(shop e[], int size) {
    for (int i = 0; i < size; i++) {
        printf(" %s %.2lf  %.2lf\n", e[i].nazvanie, e[i].kolvo, e[i].cena);
    }
}



int main() {
    e = (shop*)malloc(sizeof(shop) * size_cklad);
    set_shop(e, size_cklad);
    print_cklad(e, size_cklad);
    printf("-----------------------------\n");
    int n;
    printf("Vvedite kolvo tovarov\n");
    scanf("%d", &n);
    printf("Vvedite nazvanie(kak na sklade)     and     kolvo tovara\n");
    tovar* a;
    a = (tovar*)malloc(sizeof(tovar) * n);
    for (int i = 0; i < n + 1; i++) {
        char test[100];
        gets(test);
        parse_str(test, i, a);
    }
    itog(a, n);

    return 0;

}
